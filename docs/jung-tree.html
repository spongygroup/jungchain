<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정의 나무</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0b0e17;overflow:hidden;font-family:'SF Mono',monospace}
canvas{display:block}
.ui{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:10}
.ui button{background:rgba(20,20,40,0.8);color:#777;border:1px solid #333;padding:7px 14px;border-radius:16px;cursor:pointer;font-size:11px;font-family:inherit;transition:all .3s;backdrop-filter:blur(4px)}
.ui button:hover{color:#ccc;border-color:#555}
.ui button.active{background:rgba(60,30,20,0.9);border-color:#8B4513;color:#d4a373}
.title{position:fixed;top:24px;left:50%;transform:translateX(-50%);color:#3a3020;font-size:14px;letter-spacing:3px;z-index:10}
.info{position:fixed;top:50px;left:50%;transform:translateX(-50%);color:#2a2218;font-size:10px;z-index:10;text-align:center;letter-spacing:1px}
</style>
</head>
<body>
<div class="title">정(情)의 나무</div>
<div class="info" id="info"></div>
<canvas id="c"></canvas>
<div class="ui">
  <button onclick="selectTree(0)" id="b0" class="active">나무 1</button>
  <button onclick="selectTree(1)" id="b1">나무 2</button>
  <button onclick="selectTree(2)" id="b2">나무 3</button>
  <button onclick="selectTree(3)" id="b3">나무 4</button>
  <button onclick="selectTree(4)" id="b4">나무 5</button>
  <button onclick="toggleAll()" id="ba">숲</button>
</div>

<script>
const DATA=[{"id":49,"p":null,"fs":null,"rc":49,"bc":24},{"id":50,"p":49,"fs":2,"rc":49,"bc":2},{"id":51,"p":49,"fs":2,"rc":49,"bc":2},{"id":52,"p":49,"fs":3,"rc":49,"bc":3},{"id":53,"p":49,"fs":3,"rc":49,"bc":3},{"id":54,"p":49,"fs":3,"rc":49,"bc":3},{"id":55,"p":49,"fs":4,"rc":49,"bc":4},{"id":56,"p":49,"fs":4,"rc":49,"bc":4},{"id":57,"p":49,"fs":4,"rc":49,"bc":4},{"id":58,"p":49,"fs":5,"rc":49,"bc":5},{"id":59,"p":49,"fs":5,"rc":49,"bc":5},{"id":60,"p":49,"fs":6,"rc":49,"bc":6},{"id":61,"p":49,"fs":6,"rc":49,"bc":6},{"id":62,"p":49,"fs":6,"rc":49,"bc":6},{"id":63,"p":49,"fs":7,"rc":49,"bc":7},{"id":64,"p":49,"fs":7,"rc":49,"bc":7},{"id":65,"p":49,"fs":7,"rc":49,"bc":7},{"id":66,"p":49,"fs":8,"rc":49,"bc":8},{"id":67,"p":49,"fs":9,"rc":49,"bc":9},{"id":68,"p":49,"fs":9,"rc":49,"bc":9},{"id":69,"p":49,"fs":9,"rc":49,"bc":9},{"id":70,"p":49,"fs":10,"rc":49,"bc":10},{"id":71,"p":49,"fs":10,"rc":49,"bc":10},{"id":72,"p":49,"fs":11,"rc":49,"bc":11},{"id":73,"p":49,"fs":12,"rc":49,"bc":12},{"id":74,"p":49,"fs":13,"rc":49,"bc":13},{"id":75,"p":49,"fs":13,"rc":49,"bc":13},{"id":76,"p":49,"fs":13,"rc":49,"bc":13},{"id":77,"p":49,"fs":13,"rc":49,"bc":13},{"id":78,"p":49,"fs":14,"rc":49,"bc":14},{"id":79,"p":49,"fs":14,"rc":49,"bc":14},{"id":80,"p":49,"fs":15,"rc":49,"bc":15},{"id":81,"p":49,"fs":15,"rc":49,"bc":15},{"id":82,"p":49,"fs":15,"rc":49,"bc":15},{"id":83,"p":49,"fs":15,"rc":49,"bc":15},{"id":84,"p":49,"fs":16,"rc":49,"bc":16},{"id":85,"p":49,"fs":16,"rc":49,"bc":16},{"id":86,"p":49,"fs":17,"rc":49,"bc":17},{"id":87,"p":49,"fs":17,"rc":49,"bc":17},{"id":88,"p":49,"fs":18,"rc":49,"bc":18},{"id":89,"p":49,"fs":18,"rc":49,"bc":18},{"id":90,"p":49,"fs":18,"rc":49,"bc":18},{"id":91,"p":49,"fs":18,"rc":49,"bc":18},{"id":92,"p":49,"fs":20,"rc":49,"bc":20},{"id":93,"p":49,"fs":21,"rc":49,"bc":21},{"id":94,"p":49,"fs":22,"rc":49,"bc":22},{"id":95,"p":49,"fs":23,"rc":49,"bc":23},{"id":96,"p":49,"fs":24,"rc":49,"bc":24},{"id":97,"p":49,"fs":24,"rc":49,"bc":24},{"id":98,"p":null,"fs":null,"rc":98,"bc":24},{"id":99,"p":98,"fs":2,"rc":98,"bc":2},{"id":100,"p":98,"fs":2,"rc":98,"bc":2},{"id":101,"p":98,"fs":2,"rc":98,"bc":2},{"id":102,"p":98,"fs":2,"rc":98,"bc":2},{"id":103,"p":98,"fs":2,"rc":98,"bc":2},{"id":104,"p":98,"fs":2,"rc":98,"bc":2},{"id":105,"p":98,"fs":3,"rc":98,"bc":3},{"id":106,"p":98,"fs":3,"rc":98,"bc":3},{"id":107,"p":98,"fs":3,"rc":98,"bc":3},{"id":108,"p":98,"fs":4,"rc":98,"bc":4},{"id":109,"p":98,"fs":4,"rc":98,"bc":4},{"id":110,"p":98,"fs":4,"rc":98,"bc":4},{"id":111,"p":98,"fs":4,"rc":98,"bc":4},{"id":112,"p":98,"fs":5,"rc":98,"bc":5},{"id":113,"p":98,"fs":5,"rc":98,"bc":5},{"id":114,"p":98,"fs":5,"rc":98,"bc":5},{"id":115,"p":98,"fs":5,"rc":98,"bc":5},{"id":116,"p":98,"fs":6,"rc":98,"bc":6},{"id":117,"p":98,"fs":6,"rc":98,"bc":6},{"id":118,"p":98,"fs":6,"rc":98,"bc":6},{"id":119,"p":98,"fs":7,"rc":98,"bc":7},{"id":120,"p":98,"fs":7,"rc":98,"bc":7},{"id":121,"p":98,"fs":7,"rc":98,"bc":7},{"id":122,"p":98,"fs":7,"rc":98,"bc":7},{"id":123,"p":98,"fs":8,"rc":98,"bc":8},{"id":124,"p":98,"fs":8,"rc":98,"bc":8},{"id":125,"p":98,"fs":8,"rc":98,"bc":8},{"id":126,"p":98,"fs":9,"rc":98,"bc":9},{"id":127,"p":98,"fs":9,"rc":98,"bc":9},{"id":128,"p":98,"fs":9,"rc":98,"bc":9},{"id":129,"p":98,"fs":9,"rc":98,"bc":9},{"id":130,"p":98,"fs":9,"rc":98,"bc":9},{"id":131,"p":98,"fs":10,"rc":98,"bc":10},{"id":132,"p":98,"fs":10,"rc":98,"bc":10},{"id":133,"p":98,"fs":11,"rc":98,"bc":11},{"id":134,"p":98,"fs":12,"rc":98,"bc":12},{"id":135,"p":98,"fs":13,"rc":98,"bc":13},{"id":136,"p":98,"fs":13,"rc":98,"bc":13},{"id":137,"p":98,"fs":14,"rc":98,"bc":14},{"id":138,"p":98,"fs":14,"rc":98,"bc":14},{"id":139,"p":98,"fs":14,"rc":98,"bc":14},{"id":140,"p":98,"fs":15,"rc":98,"bc":15},{"id":141,"p":98,"fs":15,"rc":98,"bc":15},{"id":142,"p":98,"fs":15,"rc":98,"bc":15},{"id":143,"p":98,"fs":15,"rc":98,"bc":15},{"id":144,"p":98,"fs":15,"rc":98,"bc":15},{"id":145,"p":98,"fs":16,"rc":98,"bc":16},{"id":146,"p":98,"fs":16,"rc":98,"bc":16},{"id":147,"p":98,"fs":16,"rc":98,"bc":16},{"id":148,"p":98,"fs":16,"rc":98,"bc":16},{"id":149,"p":98,"fs":17,"rc":98,"bc":17},{"id":150,"p":98,"fs":17,"rc":98,"bc":17},{"id":151,"p":98,"fs":18,"rc":98,"bc":18},{"id":152,"p":98,"fs":18,"rc":98,"bc":18},{"id":153,"p":98,"fs":18,"rc":98,"bc":18},{"id":154,"p":98,"fs":20,"rc":98,"bc":20},{"id":155,"p":98,"fs":21,"rc":98,"bc":21},{"id":156,"p":98,"fs":22,"rc":98,"bc":22},{"id":157,"p":98,"fs":22,"rc":98,"bc":22},{"id":158,"p":98,"fs":23,"rc":98,"bc":23},{"id":159,"p":98,"fs":24,"rc":98,"bc":24},{"id":160,"p":null,"fs":null,"rc":160,"bc":24},{"id":161,"p":160,"fs":2,"rc":160,"bc":2},{"id":162,"p":160,"fs":4,"rc":160,"bc":4},{"id":163,"p":160,"fs":5,"rc":160,"bc":5},{"id":164,"p":160,"fs":5,"rc":160,"bc":5},{"id":165,"p":160,"fs":6,"rc":160,"bc":6},{"id":166,"p":160,"fs":7,"rc":160,"bc":7},{"id":167,"p":160,"fs":7,"rc":160,"bc":7},{"id":168,"p":160,"fs":7,"rc":160,"bc":7},{"id":169,"p":160,"fs":7,"rc":160,"bc":7},{"id":170,"p":160,"fs":8,"rc":160,"bc":8},{"id":171,"p":160,"fs":8,"rc":160,"bc":8},{"id":172,"p":160,"fs":9,"rc":160,"bc":9},{"id":173,"p":160,"fs":10,"rc":160,"bc":10},{"id":174,"p":160,"fs":10,"rc":160,"bc":10},{"id":175,"p":160,"fs":10,"rc":160,"bc":10},{"id":176,"p":160,"fs":10,"rc":160,"bc":10},{"id":177,"p":160,"fs":12,"rc":160,"bc":12},{"id":178,"p":160,"fs":13,"rc":160,"bc":13},{"id":179,"p":160,"fs":14,"rc":160,"bc":14},{"id":180,"p":160,"fs":15,"rc":160,"bc":15},{"id":181,"p":160,"fs":16,"rc":160,"bc":16},{"id":182,"p":160,"fs":16,"rc":160,"bc":16},{"id":183,"p":160,"fs":17,"rc":160,"bc":17},{"id":184,"p":160,"fs":17,"rc":160,"bc":17},{"id":185,"p":160,"fs":17,"rc":160,"bc":17},{"id":186,"p":160,"fs":17,"rc":160,"bc":17},{"id":187,"p":160,"fs":17,"rc":160,"bc":17},{"id":188,"p":160,"fs":17,"rc":160,"bc":17},{"id":189,"p":160,"fs":18,"rc":160,"bc":18},{"id":190,"p":160,"fs":18,"rc":160,"bc":18},{"id":191,"p":160,"fs":18,"rc":160,"bc":18},{"id":192,"p":160,"fs":18,"rc":160,"bc":18},{"id":193,"p":160,"fs":18,"rc":160,"bc":18},{"id":194,"p":160,"fs":19,"rc":160,"bc":19},{"id":195,"p":160,"fs":19,"rc":160,"bc":19},{"id":196,"p":160,"fs":20,"rc":160,"bc":20},{"id":197,"p":160,"fs":20,"rc":160,"bc":20},{"id":198,"p":160,"fs":20,"rc":160,"bc":20},{"id":199,"p":160,"fs":21,"rc":160,"bc":21},{"id":200,"p":160,"fs":21,"rc":160,"bc":21},{"id":201,"p":160,"fs":21,"rc":160,"bc":21},{"id":202,"p":160,"fs":21,"rc":160,"bc":21},{"id":203,"p":160,"fs":23,"rc":160,"bc":23},{"id":204,"p":160,"fs":23,"rc":160,"bc":23},{"id":205,"p":160,"fs":23,"rc":160,"bc":23},{"id":206,"p":160,"fs":24,"rc":160,"bc":24},{"id":207,"p":160,"fs":24,"rc":160,"bc":24},{"id":208,"p":160,"fs":24,"rc":160,"bc":24},{"id":209,"p":null,"fs":null,"rc":209,"bc":24},{"id":210,"p":209,"fs":2,"rc":209,"bc":2},{"id":211,"p":209,"fs":2,"rc":209,"bc":2},{"id":212,"p":209,"fs":2,"rc":209,"bc":2},{"id":213,"p":209,"fs":3,"rc":209,"bc":3},{"id":214,"p":209,"fs":3,"rc":209,"bc":3},{"id":215,"p":209,"fs":4,"rc":209,"bc":4},{"id":216,"p":209,"fs":4,"rc":209,"bc":4},{"id":217,"p":209,"fs":4,"rc":209,"bc":4},{"id":218,"p":209,"fs":4,"rc":209,"bc":4},{"id":219,"p":209,"fs":6,"rc":209,"bc":6},{"id":220,"p":209,"fs":7,"rc":209,"bc":7},{"id":221,"p":209,"fs":8,"rc":209,"bc":8},{"id":222,"p":209,"fs":8,"rc":209,"bc":8},{"id":223,"p":209,"fs":9,"rc":209,"bc":9},{"id":224,"p":209,"fs":10,"rc":209,"bc":10},{"id":225,"p":209,"fs":11,"rc":209,"bc":11},{"id":226,"p":209,"fs":11,"rc":209,"bc":11},{"id":227,"p":209,"fs":11,"rc":209,"bc":11},{"id":228,"p":209,"fs":11,"rc":209,"bc":11},{"id":229,"p":209,"fs":11,"rc":209,"bc":11},{"id":230,"p":209,"fs":11,"rc":209,"bc":11},{"id":231,"p":209,"fs":12,"rc":209,"bc":12},{"id":232,"p":209,"fs":12,"rc":209,"bc":12},{"id":233,"p":209,"fs":12,"rc":209,"bc":12},{"id":234,"p":209,"fs":13,"rc":209,"bc":13},{"id":235,"p":209,"fs":13,"rc":209,"bc":13},{"id":236,"p":209,"fs":13,"rc":209,"bc":13},{"id":237,"p":209,"fs":14,"rc":209,"bc":14},{"id":238,"p":209,"fs":14,"rc":209,"bc":14},{"id":239,"p":209,"fs":14,"rc":209,"bc":14},{"id":240,"p":209,"fs":15,"rc":209,"bc":15},{"id":241,"p":209,"fs":15,"rc":209,"bc":15},{"id":242,"p":209,"fs":15,"rc":209,"bc":15},{"id":243,"p":209,"fs":15,"rc":209,"bc":15},{"id":244,"p":209,"fs":16,"rc":209,"bc":16},{"id":245,"p":209,"fs":16,"rc":209,"bc":16},{"id":246,"p":209,"fs":16,"rc":209,"bc":16},{"id":247,"p":209,"fs":17,"rc":209,"bc":17},{"id":248,"p":209,"fs":17,"rc":209,"bc":17},{"id":249,"p":209,"fs":17,"rc":209,"bc":17},{"id":250,"p":209,"fs":17,"rc":209,"bc":17},{"id":251,"p":209,"fs":18,"rc":209,"bc":18},{"id":252,"p":209,"fs":18,"rc":209,"bc":18},{"id":253,"p":209,"fs":18,"rc":209,"bc":18},{"id":254,"p":209,"fs":19,"rc":209,"bc":19},{"id":255,"p":209,"fs":19,"rc":209,"bc":19},{"id":256,"p":209,"fs":19,"rc":209,"bc":19},{"id":257,"p":209,"fs":19,"rc":209,"bc":19},{"id":258,"p":209,"fs":19,"rc":209,"bc":19},{"id":259,"p":209,"fs":20,"rc":209,"bc":20},{"id":260,"p":209,"fs":22,"rc":209,"bc":22},{"id":261,"p":209,"fs":23,"rc":209,"bc":23},{"id":262,"p":209,"fs":23,"rc":209,"bc":23},{"id":263,"p":209,"fs":23,"rc":209,"bc":23},{"id":264,"p":209,"fs":24,"rc":209,"bc":24},{"id":265,"p":209,"fs":24,"rc":209,"bc":24},{"id":266,"p":null,"fs":null,"rc":266,"bc":24},{"id":267,"p":266,"fs":3,"rc":266,"bc":3},{"id":268,"p":266,"fs":4,"rc":266,"bc":4},{"id":269,"p":266,"fs":5,"rc":266,"bc":5},{"id":270,"p":266,"fs":6,"rc":266,"bc":6},{"id":271,"p":266,"fs":7,"rc":266,"bc":7},{"id":272,"p":266,"fs":7,"rc":266,"bc":7},{"id":273,"p":266,"fs":8,"rc":266,"bc":8},{"id":274,"p":266,"fs":8,"rc":266,"bc":8},{"id":275,"p":266,"fs":8,"rc":266,"bc":8},{"id":276,"p":266,"fs":8,"rc":266,"bc":8},{"id":277,"p":266,"fs":8,"rc":266,"bc":8},{"id":278,"p":266,"fs":9,"rc":266,"bc":9},{"id":279,"p":266,"fs":9,"rc":266,"bc":9},{"id":280,"p":266,"fs":9,"rc":266,"bc":9},{"id":281,"p":266,"fs":9,"rc":266,"bc":9},{"id":282,"p":266,"fs":10,"rc":266,"bc":10},{"id":283,"p":266,"fs":10,"rc":266,"bc":10},{"id":284,"p":266,"fs":10,"rc":266,"bc":10},{"id":285,"p":266,"fs":10,"rc":266,"bc":10},{"id":286,"p":266,"fs":11,"rc":266,"bc":11},{"id":287,"p":266,"fs":11,"rc":266,"bc":11},{"id":288,"p":266,"fs":11,"rc":266,"bc":11},{"id":289,"p":266,"fs":12,"rc":266,"bc":12},{"id":290,"p":266,"fs":12,"rc":266,"bc":12},{"id":291,"p":266,"fs":12,"rc":266,"bc":12},{"id":292,"p":266,"fs":13,"rc":266,"bc":13},{"id":293,"p":266,"fs":13,"rc":266,"bc":13},{"id":294,"p":266,"fs":14,"rc":266,"bc":14},{"id":295,"p":266,"fs":14,"rc":266,"bc":14},{"id":296,"p":266,"fs":14,"rc":266,"bc":14},{"id":297,"p":266,"fs":15,"rc":266,"bc":15},{"id":298,"p":266,"fs":15,"rc":266,"bc":15},{"id":299,"p":266,"fs":15,"rc":266,"bc":15},{"id":300,"p":266,"fs":16,"rc":266,"bc":16},{"id":301,"p":266,"fs":16,"rc":266,"bc":16},{"id":302,"p":266,"fs":16,"rc":266,"bc":16},{"id":303,"p":266,"fs":16,"rc":266,"bc":16},{"id":304,"p":266,"fs":17,"rc":266,"bc":17},{"id":305,"p":266,"fs":17,"rc":266,"bc":17},{"id":306,"p":266,"fs":17,"rc":266,"bc":17},{"id":307,"p":266,"fs":18,"rc":266,"bc":18},{"id":308,"p":266,"fs":19,"rc":266,"bc":19},{"id":309,"p":266,"fs":20,"rc":266,"bc":20},{"id":310,"p":266,"fs":20,"rc":266,"bc":20},{"id":311,"p":266,"fs":21,"rc":266,"bc":21},{"id":312,"p":266,"fs":21,"rc":266,"bc":21},{"id":313,"p":266,"fs":22,"rc":266,"bc":22},{"id":314,"p":266,"fs":22,"rc":266,"bc":22},{"id":315,"p":266,"fs":22,"rc":266,"bc":22},{"id":316,"p":266,"fs":22,"rc":266,"bc":22},{"id":317,"p":266,"fs":22,"rc":266,"bc":22},{"id":318,"p":266,"fs":23,"rc":266,"bc":23},{"id":319,"p":266,"fs":23,"rc":266,"bc":23},{"id":320,"p":266,"fs":23,"rc":266,"bc":23},{"id":321,"p":266,"fs":24,"rc":266,"bc":24},{"id":322,"p":266,"fs":24,"rc":266,"bc":24}];

const roots=[49,98,160,209,266];
const trees=roots.map(rid=>{
  const cs=DATA.filter(d=>d.rc===rid);
  return{rootId:rid,forks:cs.filter(c=>c.p!==null),total:cs.length};
});

const cv=document.getElementById('c');
const ctx=cv.getContext('2d');
let W,H,currentTree=0,showAll=false,grow=0,growing=true,time=0;

// Seeded random per tree for consistent shapes
function seeded(s){return()=>{s=(s*16807+0)%2147483647;return(s-1)/2147483646;}}

function resize(){W=cv.width=innerWidth;H=cv.height=innerHeight;}
resize();
addEventListener('resize',resize);

// Precompute branch layouts (deterministic per tree)
function layoutTree(tree,cx,baseY,treeH,scale){
  const rng=seeded(tree.rootId*7919);
  const slotH=treeH/26;
  const branches=[];

  // --- Roots (underground) ---
  for(let i=0;i<5;i++){
    const angle=(rng()-0.5)*1.4;
    const len=30+rng()*50;
    branches.push({type:'root',
      x1:cx,y1:baseY,
      x2:cx+Math.sin(angle)*len*scale,
      y2:baseY+Math.cos(angle*0.3)*len*0.6*scale,
      w:(3-i*0.4)*scale,seed:rng()*999
    });
  }

  // --- Trunk path (bezier with organic sway) ---
  const trunkSeed=rng()*999;
  const trunkLean=(rng()-0.5)*30*scale;
  const trunkPts=[];
  for(let i=0;i<=120;i++){
    const t=i/120;
    const sway=Math.sin(t*3.5+trunkSeed)*12*t*scale+trunkLean*t*t;
    trunkPts.push({x:cx+sway,y:baseY-t*24*slotH,t});
  }
  branches.push({type:'trunk',pts:trunkPts,maxW:10*scale,minW:3*scale,seed:trunkSeed});

  // Helper: get trunk position at slot
  function trunkAt(slot){
    const t=slot/24;
    const idx=Math.min(Math.floor(t*120),119);
    const p=trunkPts[idx];
    return{x:p.x,y:p.y};
  }

  // --- Branches from forks ---
  const bySlot={};
  for(const f of tree.forks){if(!bySlot[f.fs])bySlot[f.fs]=[];bySlot[f.fs].push(f);}

  let bi=0;
  for(const[slot,forks]of Object.entries(bySlot)){
    const s=parseInt(slot);
    const tp=trunkAt(s);

    for(let i=0;i<forks.length;i++){
      const f=forks[i];
      const remain=24-s;
      const side=(bi%2===0)?-1:1;
      const baseAngle=0.3+rng()*0.7;
      const angle=side*baseAngle;
      const branchLen=(remain*slotH*0.4+rng()*40)*scale;
      const curveSeed=rng()*999;

      // Branch curves upward and outward
      const pts=[];
      const steps=40;
      for(let j=0;j<=steps;j++){
        const t=j/steps;
        const outward=Math.sin(angle)*branchLen*t;
        const upward=-branchLen*t*0.8;
        const wobble=Math.sin(t*5+curveSeed)*4*t*scale;
        pts.push({
          x:tp.x+outward+wobble,
          y:tp.y+upward+Math.sin(t*2+curveSeed)*8*t*scale,
          t
        });
      }

      // Sub-branches (smaller twigs from this branch)
      const twigs=[];
      const twigCount=Math.floor(rng()*3)+1;
      for(let k=0;k<twigCount;k++){
        const tt=0.4+rng()*0.5;
        const ti=Math.floor(tt*steps);
        const bp=pts[ti];
        const tSide=(rng()>0.5)?1:-1;
        const tLen=(10+rng()*25)*scale;
        const tSeed=rng()*999;
        const twigPts=[];
        for(let j=0;j<=15;j++){
          const t2=j/15;
          twigPts.push({
            x:bp.x+tSide*tLen*t2+Math.sin(t2*4+tSeed)*3*scale,
            y:bp.y-tLen*t2*0.5,t:t2
          });
        }
        twigs.push({pts:twigPts,w:1.2*scale,seed:tSeed});
      }

      branches.push({
        type:'branch',slot:s,pts,
        maxW:(3.5-s*0.08)*scale,minW:0.8*scale,
        twigs,seed:curveSeed,side,
        leafColor:bi%5
      });
      bi++;
    }
  }

  return branches;
}

// Leaf clusters (drawn at branch tips + along branches)
function drawLeafCluster(x,y,size,color,alpha,windOffset){
  const colors=[
    ['#2d5a1e','#3a7a28','#4a9a32','#5cb84a'],
    ['#c73650','#e94560','#ff6b81','#ff8fa3'],
    ['#d4940a','#f0a500','#ffc048','#ffe08a'],
    ['#1a6b4a','#228b5a','#2aab6a','#45c98a'],
    ['#6a3d8a','#8a5ab0','#aa7ad0','#cca0e8'],
  ];
  const pal=colors[color%colors.length];

  for(let i=0;i<6;i++){
    const a=i*1.05+windOffset*0.3;
    const r=size*(0.4+Math.sin(i*2.3)*0.3);
    const lx=x+Math.cos(a)*r;
    const ly=y+Math.sin(a)*r*0.7;
    const ls=size*(0.3+Math.sin(i*3.1)*0.15);

    ctx.beginPath();
    ctx.ellipse(lx,ly,ls,ls*0.7,a*0.5,0,Math.PI*2);
    ctx.fillStyle=hexA(pal[i%pal.length],alpha*0.7);
    ctx.fill();
  }
  // Center glow
  const g=ctx.createRadialGradient(x,y,0,x,y,size*0.5);
  g.addColorStop(0,hexA(pal[1],alpha*0.3));
  g.addColorStop(1,hexA(pal[1],0));
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.arc(x,y,size*0.5,0,Math.PI*2);
  ctx.fill();
}

function hexA(hex,a){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return`rgba(${r},${g},${b},${Math.max(0,Math.min(1,a))})`;
}

function drawPath(pts,maxPts,w1,w2,color1,color2,alpha){
  const n=Math.min(maxPts,pts.length);
  if(n<2)return;
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<n;i++){
    const p=pts[i-1],c=pts[i];
    ctx.quadraticCurveTo(p.x,p.y,(p.x+c.x)/2,(p.y+c.y)/2);
  }
  const last=pts[n-1];
  ctx.lineTo(last.x,last.y);
  ctx.strokeStyle=hexA(color1,alpha);
  ctx.lineWidth=w1;
  ctx.lineCap='round';
  ctx.stroke();
}

function drawTrunk(b,progress,alpha,windT){
  const pts=b.pts;
  const n=Math.floor(pts.length*progress);
  if(n<2)return;

  // Draw trunk with tapering width
  for(let i=1;i<n;i++){
    const t=i/pts.length;
    const w=b.maxW*(1-t*0.7)+b.minW*t;
    const wind=Math.sin(windT+t*2)*2*t;

    ctx.beginPath();
    ctx.moveTo(pts[i-1].x+wind,pts[i-1].y);
    ctx.lineTo(pts[i].x+wind,pts[i].y);

    // Bark color gradient
    const brown=Math.floor(60+t*30);
    ctx.strokeStyle=hexA(`#${(brown+20).toString(16)}${(brown-10).toString(16)}${(brown-25).toString(16)}`,alpha);
    ctx.lineWidth=w;
    ctx.lineCap='round';
    ctx.stroke();
  }

  // Bark texture
  for(let i=0;i<n;i+=6){
    const p=pts[i];
    const t=i/pts.length;
    const w=b.maxW*(1-t*0.7);
    const wind=Math.sin(windT+t*2)*2*t;
    ctx.beginPath();
    ctx.moveTo(p.x+wind-w*0.3,p.y);
    ctx.lineTo(p.x+wind+w*0.1,p.y-2);
    ctx.strokeStyle=hexA('#1a1008',alpha*0.3);
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function drawBranch(b,progress,alpha,windT,treeIdx){
  const pts=b.pts;
  const branchProgress=Math.max(0,Math.min(1,(progress-b.slot/26)/(1-b.slot/26)));
  const n=Math.floor(pts.length*branchProgress);
  if(n<2)return;

  // Branch with taper
  for(let i=1;i<n;i++){
    const t=i/pts.length;
    const w=b.maxW*(1-t)+b.minW*t;
    const wind=Math.sin(windT*1.3+t*3+b.seed)*3*t;

    ctx.beginPath();
    ctx.moveTo(pts[i-1].x+wind,pts[i-1].y);
    ctx.lineTo(pts[i].x+wind,pts[i].y);

    const brown=Math.floor(70+t*20);
    ctx.strokeStyle=hexA(`#${(brown+10).toString(16)}${(brown-5).toString(16)}${(brown-20).toString(16)}`,alpha*(1-t*0.3));
    ctx.lineWidth=w;
    ctx.lineCap='round';
    ctx.stroke();
  }

  // Twigs
  for(const tw of b.twigs){
    const twigProg=Math.max(0,(branchProgress-0.3)/0.7);
    const tn=Math.floor(tw.pts.length*twigProg);
    if(tn<2)continue;
    for(let i=1;i<tn;i++){
      const t=i/tw.pts.length;
      const wind=Math.sin(windT*1.5+t*4+tw.seed)*4*t;
      ctx.beginPath();
      ctx.moveTo(tw.pts[i-1].x+wind,tw.pts[i-1].y);
      ctx.lineTo(tw.pts[i].x+wind,tw.pts[i].y);
      ctx.strokeStyle=hexA('#4a3520',alpha*(1-t*0.5));
      ctx.lineWidth=tw.w*(1-t*0.6);
      ctx.lineCap='round';
      ctx.stroke();
    }
    // Leaf at twig tip
    if(twigProg>0.8){
      const tip=tw.pts[tn-1];
      const wind=Math.sin(windT*1.5+tw.seed)*4;
      drawLeafCluster(tip.x+wind,tip.y,6+Math.sin(tw.seed)*2,b.leafColor,alpha*(twigProg-0.8)*5,windT+tw.seed);
    }
  }

  // Leaf cluster at branch tip
  if(branchProgress>0.7){
    const tip=pts[n-1];
    const wind=Math.sin(windT*1.3+b.seed)*3;
    const leafAlpha=alpha*Math.min(1,(branchProgress-0.7)*3.3);
    drawLeafCluster(tip.x+wind,tip.y,10+Math.sin(b.seed*2)*4,b.leafColor,leafAlpha,windT+b.seed);
  }
}

function drawRoot(b,progress,alpha){
  const p=Math.min(1,progress*3);
  if(p<0.01)return;
  const steps=20;
  for(let i=1;i<=Math.floor(steps*p);i++){
    const t=i/steps;
    const x=b.x1+(b.x2-b.x1)*t+Math.sin(t*6+b.seed)*3;
    const y=b.y1+(b.y2-b.y1)*t;
    const px=b.x1+(b.x2-b.x1)*((i-1)/steps)+Math.sin(((i-1)/steps)*6+b.seed)*3;
    const py=b.y1+(b.y2-b.y1)*((i-1)/steps);
    ctx.beginPath();
    ctx.moveTo(px,py);
    ctx.lineTo(x,y);
    ctx.strokeStyle=hexA('#3a2510',alpha*(1-t*0.6));
    ctx.lineWidth=b.w*(1-t*0.5);
    ctx.lineCap='round';
    ctx.stroke();
  }
}

function renderTree(tree,treeIdx,cx,baseY,treeH,scale,alpha,progress){
  const branches=layoutTree(tree,cx,baseY,treeH,scale);
  const windT=time*0.6;

  // Ground shadow
  const sg=ctx.createRadialGradient(cx,baseY,0,cx,baseY,60*scale);
  sg.addColorStop(0,hexA('#0a0a00',alpha*0.3));
  sg.addColorStop(1,hexA('#0a0a00',0));
  ctx.fillStyle=sg;
  ctx.beginPath();
  ctx.ellipse(cx,baseY+5,60*scale,12*scale,0,0,Math.PI*2);
  ctx.fill();

  // Roots
  for(const b of branches)if(b.type==='root')drawRoot(b,progress,alpha);
  // Trunk
  for(const b of branches)if(b.type==='trunk')drawTrunk(b,progress,alpha,windT);
  // Branches
  for(const b of branches)if(b.type==='branch')drawBranch(b,progress,alpha,windT,treeIdx);

  // Crown glow (top of tree atmosphere)
  if(progress>0.5){
    const topY=baseY-treeH*0.85;
    const cg=ctx.createRadialGradient(cx,topY,0,cx,topY,treeH*0.35);
    cg.addColorStop(0,hexA('#2a4a1a',alpha*0.06*Math.min(1,(progress-0.5)*2)));
    cg.addColorStop(1,hexA('#1a2a0a',0));
    ctx.fillStyle=cg;
    ctx.beginPath();
    ctx.arc(cx,topY,treeH*0.35,0,Math.PI*2);
    ctx.fill();
  }
}

// Falling leaves
const leaves=[];
function spawnLeaf(){
  if(leaves.length>30)return;
  leaves.push({
    x:W*Math.random(),y:-10,
    vx:(Math.random()-0.5)*0.5,vy:0.3+Math.random()*0.5,
    rot:Math.random()*Math.PI*2,rotV:(Math.random()-0.5)*0.03,
    size:2+Math.random()*3,
    color:['#3a7a28','#c73650','#f0a500','#5cb84a','#aa7ad0'][Math.floor(Math.random()*5)],
    alpha:0.4+Math.random()*0.3
  });
}

function updateLeaves(){
  for(let i=leaves.length-1;i>=0;i--){
    const l=leaves[i];
    l.x+=l.vx+Math.sin(time+l.rot)*0.3;
    l.y+=l.vy;
    l.rot+=l.rotV;
    l.alpha-=0.001;
    if(l.y>H||l.alpha<=0)leaves.splice(i,1);
  }
}

function drawLeaves(){
  for(const l of leaves){
    ctx.save();
    ctx.translate(l.x,l.y);
    ctx.rotate(l.rot);
    ctx.beginPath();
    ctx.ellipse(0,0,l.size,l.size*0.5,0,0,Math.PI*2);
    ctx.fillStyle=hexA(l.color,l.alpha);
    ctx.fill();
    ctx.restore();
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  time+=0.016;

  // Sky gradient (very subtle)
  const sky=ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#08090f');
  sky.addColorStop(0.7,'#0b0e17');
  sky.addColorStop(1,'#0f1210');
  ctx.fillStyle=sky;
  ctx.fillRect(0,0,W,H);

  const groundY=H*0.82;

  // Ground line
  ctx.beginPath();
  ctx.moveTo(0,groundY);
  ctx.lineTo(W,groundY);
  ctx.strokeStyle='rgba(40,30,20,0.3)';
  ctx.lineWidth=1;
  ctx.stroke();

  if(grow<1&&growing)spawnLeaf();
  updateLeaves();

  if(showAll){
    const sp=W/6;
    for(let i=0;i<5;i++){
      renderTree(trees[i],i,sp*(i+1),groundY,H*0.65,0.55,0.85,grow);
    }
    document.getElementById('info').textContent='5 roots · 274 chains · 3,576 blocks';
  }else{
    renderTree(trees[currentTree],currentTree,W/2,groundY,H*0.7,1,1,grow);
    const t=trees[currentTree];
    document.getElementById('info').textContent=`root #${t.rootId} · ${t.total} chains · ${t.forks.length} forks`;
  }

  drawLeaves();

  if(growing){
    grow+=0.004;
    if(grow>=1){grow=1;growing=false;}
  }

  requestAnimationFrame(draw);
}

function selectTree(i){
  showAll=false;currentTree=i;grow=0;growing=true;
  for(let j=0;j<5;j++)document.getElementById('b'+j).classList.toggle('active',j===i);
  document.getElementById('ba').classList.remove('active');
}
function toggleAll(){
  showAll=!showAll;grow=0;growing=true;
  for(let j=0;j<5;j++)document.getElementById('b'+j).classList.remove('active');
  document.getElementById('ba').classList.toggle('active',showAll);
  if(!showAll)selectTree(currentTree);
}

draw();
</script>
</body>
</html>
